<template>
    <div data-name="main-menu">
        <div class="tab tab-active" id="tab-1">
            <div id="accordion" class="accordion-item accordion-item-opened padding-top">
                <div class="accordion-item-content">
                    <!-- Conssentimento -->
                    <div id="consent" class="consentTab">
                        <div class="card padding-bottom">
                            <div class="h100 card-content-padding">
                                <div class="card-question card-content">
                                    Você permite que o aplicativo armazene as informações que você responder neste
                                    questionário?
                                    <br>Elas podem ser úteis para manter o registro de como anda sua saúde mental.
                                </div>

                                <div class="row margin-top">
                                    <button @click="haveConsent()"
                                        class="button col button-outline button-round">Sim</button>
                                    <button id="button_toggle"
                                        class="button col button-outline button-round accordion-item-toggle">Não</button>
                                </div>
                                <div style="width: 100%; text-align: center; padding-top: 35px;">
                                    <a href="/consent/">saiba mais</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div data-pagination='{"el": ".swiper-pagination"}' class="swiper-container" id="emoji-poll-swiper">
                        <div class="swiper-pagination"></div>
                        <div class="swiper-wrapper">
                            <div class="swiper-slide" id="card-sleep">
                                <div class="card padding-bottom">
                                    <div id="card-content-sleep" class="h100">
                                        <div class="card-question card-content card-content-padding">
                                            <p>Como foi a qualidade do seu sono noite passada?</p>
                                        </div>
                                        <div class="row padding">
                                            <div class="row">
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(0, 'sleep')" class="lottie"
                                                        src="https://assets5.lottiefiles.com/packages/lf20_pojzngga.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(1, 'sleep')" class="lottie"
                                                        src="https://assets7.lottiefiles.com/packages/lf20_21fbl4co.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(2, 'sleep')" class="lottie"
                                                        src="https://assets1.lottiefiles.com/packages/lf20_s1u9tqu9.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(3, 'sleep')" class="lottie"
                                                        src="https://assets2.lottiefiles.com/packages/lf20_xlbwcmun.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(4, 'sleep')" class="lottie"
                                                        src="https://assets5.lottiefiles.com/packages/lf20_ivobmnxv.json">
                                                    </lottie-player>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="swiper-slide" id="card-food">
                                <div class="card padding-bottom">
                                    <div id="card-content-food" class="h100">
                                        <div class="card-question card-content card-content-padding">
                                            <p>Como foi a qualidade da sua alimentação hoje?</p>
                                        </div>
                                        <div class="row padding">
                                            <div class="row">
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(0, 'food')" class="lottie"
                                                        src="https://assets5.lottiefiles.com/packages/lf20_pojzngga.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(1, 'food')" class="lottie"
                                                        src="https://assets7.lottiefiles.com/packages/lf20_21fbl4co.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(2, 'food')" class="lottie"
                                                        src="https://assets1.lottiefiles.com/packages/lf20_s1u9tqu9.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(3, 'food')" class="lottie"
                                                        src="https://assets2.lottiefiles.com/packages/lf20_xlbwcmun.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(4, 'food')" class="lottie"
                                                        src="https://assets5.lottiefiles.com/packages/lf20_ivobmnxv.json">
                                                    </lottie-player>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="swiper-slide" id="card-happiness">
                                <div class="card padding-bottom">
                                    <div id="card-content-happiness" class="h100">
                                        <div class="card-question card-content card-content-padding">
                                            <p>Como você está se sentindo agora?</p>
                                        </div>
                                        <div class="row padding">
                                            <div class="row">
                                                <div class="col-20">
                                                    <lottie-player id="teste1" @click="pollLevel(0, 'hapiness')"
                                                        class="lottie"
                                                        src="https://assets5.lottiefiles.com/packages/lf20_pojzngga.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(1, 'hapiness')" class="lottie"
                                                        src="https://assets7.lottiefiles.com/packages/lf20_21fbl4co.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(2, 'hapiness')" class="lottie"
                                                        src="https://assets1.lottiefiles.com/packages/lf20_s1u9tqu9.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(3, 'hapiness')" class="lottie"
                                                        src="https://assets2.lottiefiles.com/packages/lf20_xlbwcmun.json">
                                                    </lottie-player>
                                                </div>
                                                <div class="col-20">
                                                    <lottie-player @click="pollLevel(4, 'hapiness')" class="lottie"
                                                        src="https://assets5.lottiefiles.com/packages/lf20_ivobmnxv.json">
                                                    </lottie-player>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div data-pagination='{"el": ".swiper-pagination"}' class="swiper-container"
                        id="button-poll-swiper">
                        <div class="swiper-pagination"></div>
                        <div class="swiper-wrapper">
                            <div class="swiper-slide" id="card-physical-activity">
                                <div class="card padding-bottom">
                                    <div id="card-content-physical-activity" class="h100 card-content-padding">
                                        <div class="card-question card-content">
                                            Quantos minutos você passou praticando alguma atividade física hoje?
                                        </div>

                                        <div class="row margin-top">
                                            <button @click="pollLevel(0, 'physical-activity')"
                                                class="button col button-outline button-round">0</button>
                                            <button @click="pollLevel(1, 'physical-activity')"
                                                class="button col button-outline button-round">5</button>
                                            <button @click="pollLevel(2, 'physical-activity')"
                                                class="button col button-outline button-round">10</button>
                                            <button @click="pollLevel(3, 'physical-activity')"
                                                class="button col button-outline button-round">15</button>
                                            <button @click="pollLevel(4, 'physical-activity')"
                                                class="button col button-outline button-round">20</button>
                                            <button @click="pollLevel(5, 'physical-activity')"
                                                class="button col button-outline button-round">25+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="swiper-slide" id="card-leisure">
                                <div class="card padding-bottom">
                                    <div id="card-content-leisure" class="h100 card-content-padding">
                                        <div class="card-question card-content">
                                            Realizou atividades de lazer hoje? <br><br>
                                        </div>

                                        <div class="row margin-top">
                                            <button @click="pollLevel(1, 'leisure')"
                                                class="button col button-outline button-round">Sim</button>
                                            <button @click="pollLevel(0, 'leisure')"
                                                class="button col button-outline button-round">Não</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item-toggle row justify-content-center f7-icons"
                    style="width: 100%; font-size: 35px;" id="arrow_toggle">
                    chevron_compact_up
                </div>
            </div>

            <!-- Menu -->
            <div class="menu-grid">
                <a href="/common-disorders/" class="menu-grid__item">
                    <div class="item-inner">
                        <img src="static/images/ask-for-help.png" class="menu-grid__icon">
                        <div class="item-title">Transtornos comuns</div>
                    </div>
                </a>

                <a href="/tip-menu/" class="menu-grid__item">
                    <div class="item-inner">
                        <img src="static/images/mental-health.png" class="menu-grid__icon">
                        <div class="item-title">Dicas</div>
                    </div>
                </a>

                <a href="/meditation/" class="menu-grid__item">
                    <div class="item-inner">
                        <img src="static/images/meditation2.png" class="menu-grid__icon">
                        <div class="item-title">Meditação Guiada</div>
                    </div>
                </a>
                <a href="/track-menu/" class="menu-grid__item">
                    <div class="item-inner">
                        <img src="static/images/know-yourself.png" class="menu-grid__icon">
                        <div class="item-title">Acompanhamento</div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</template>
<script>
    import * as LottiePlayer from "@lottiefiles/lottie-player";

    export default {
        data: function () {
            return {
                emojiPollSwiper: null,
                buttonPollSwiper: null,
            }
        },
        methods: {
            haveConsent: function () {
                var self = this;
                var app = self.$app;
                app.storage.setConsent();
                this.checkConsent();
            },

            checkConsent: function () {
                var self = this;
                var app = self.$app;
                let blocker;
                blocker = app.$$("#consent");
                if (app.storage.getConsent() == "true") {
                    blocker.hide();
                };
            },

            swipersInit: async function () {
                var self = this;
                var app = self.$app;

                app.swiper.create('.swiper-container', {
                    pagination: {
                        el: '.swiper-pagination',
                        type: 'bullets',
                    },
                });
                await self.$setState({
                    emojiPollSwiper: app.swiper.get('#emoji-poll-swiper'),
                    buttonPollSwiper: app.swiper.get('#button-poll-swiper'),
                });
            },
            lottieInit: function () {
                var self = this;
                var app = self.$app;

                app.$$('.lottie').on('load', function (e) {
                    const player = e.target;
                    player.stop();
                    player.play();
                });

                app.$$('.lottie').on('click', async function (e) {
                    let emoji = e.target;
                    emoji.stop();
                    emoji.play();
                    app.$$(emoji).transition(1000);
                    await app.$$(emoji).transform('scale(1.3)');
                    setTimeout(() => {
                        app.$$(emoji).transform('scale(1)');
                    }, 2000);
                });
            },
            checkNeedQuestionnarie: function (type) {
                var self = this;
                var app = self.$app;

                var contentSlide;
                var itemHistory;

                switch (type) {
                    case "sleep":
                        contentSlide = app.$$("#card-sleep");
                        itemHistory = app.storage.getSleepHistory();
                        break;
                    case "food":
                        contentSlide = app.$$("#card-food");
                        itemHistory = app.storage.getFoodHistory();
                        break;
                    case "physical-activity":
                        contentSlide = app.$$("#card-physical-activity");
                        itemHistory = app.storage.getPhysicalActivityHistory();
                        break;
                    case "leisure":
                        contentSlide = app.$$("#card-leisure");
                        itemHistory = app.storage.getLeisureHistory();
                        break;
                    default:
                        console.log("error");
                }

                if (itemHistory == null) {
                    contentSlide.show();
                    return true;
                }

                let lastUpdateFromStorage = itemHistory.history[itemHistory.history.length - 1];
                let lastUpdate = new Date(lastUpdateFromStorage.created_at);
                let now = new Date();

                if (now.getFullYear() === lastUpdate.getFullYear() && now.getMonth() === lastUpdate.getMonth() &&
                    now.getDate() === lastUpdate.getDate()) {
                    contentSlide.hide();
                    return;
                }
                contentSlide.show();
                return;
            },
            pollLevel: async function (answer, type) {
                var self = this;
                var app = self.$app;

                var pollCard;
                var contentSlide;
                var timeout = 600;
                var animationTimeout = 3000;
                var hideContentSlide = true;

                switch (type) {
                    case "sleep":
                        pollCard = app.$$("#card-content-sleep");
                        contentSlide = app.$$("#card-sleep");
                        app.storage.setSleepHistory(answer);
                        break;
                    case "food":
                        pollCard = app.$$("#card-content-food");
                        contentSlide = app.$$("#card-food");
                        app.storage.setFoodHistory(answer);
                        break;
                    case "physical-activity":
                        pollCard = app.$$("#card-content-physical-activity");
                        contentSlide = app.$$("#card-physical-activity");
                        app.storage.setPhysicalActivityHistory(answer);
                        animationTimeout = 0;
                        break;
                    case "leisure":
                        pollCard = app.$$("#card-content-leisure");
                        contentSlide = app.$$("#card-leisure");
                        app.storage.setLeisureHistory(answer);
                        break;
                    case "hapiness":
                        pollCard = app.$$("#card-content-happiness");
                        contentSlide = app.$$("#card-happiness");
                        app.storage.setHappinessHistory(answer);
                        timeout = 30000;
                        hideContentSlide = false;
                        break;
                    default:
                        console.log("error");
                }

                contentSlide.css("pointer-events", "none");

                await new Promise(resolve => setTimeout(() => {
                    pollCard.animate({
                        'opacity': 0,
                    }, {
                        duration: 500,
                        easing: 'ease-in'
                    });
                    resolve();
                }, animationTimeout));

                setTimeout(() => {
                    contentSlide.hide();
                    // pollCard.hide();
                    pollCard.css('opacity', '1');
                    contentSlide.css("pointer-events", "auto");
                    this.showToastBottom();
                    self.buttonPollSwiper.update();
                    self.emojiPollSwiper.update();

                }, 600);

                setTimeout(function () {
                    pollCard.show();
                    contentSlide.show();
                    if (hideContentSlide) {
                        contentSlide.hide();
                    }
                    self.emojiPollSwiper.update();
                    self.buttonPollSwiper.update();
                }, timeout);
            },

            showToastBottom: function () {
                let toastBottom;
                var self = this;
                var app = self.$app;
                // Create toast
                if (!toastBottom) {
                    toastBottom = app.toast.create({
                        text: 'Obrigado pela sua resposta! :)',
                        closeTimeout: 3000,
                    });
                }
                // Open it
                toastBottom.open();
            },
        },
        on: {
            tabInit: function () {
                var self = this;
                var app = self.$app;

                var types = ["sleep", "food", "physical-activity", "leisure"];

                for (let type of types) {
                    this.checkNeedQuestionnarie(type);
                }

                app.$$('#arrow_toggle').click((e) => {
                    let accordion = app.$$('div.accordion-item');
                    let arrow = app.$$(e.target);
                    arrow.transition(600);

                    if (accordion.hasClass('accordion-item-opened')) {
                        arrow.transform('rotateX(0deg)');
                    } else {
                        arrow.transform('rotateX(180deg)');
                    }
                })

                app.$$('#button_toggle').click((e) => {
                    let accordion = app.$$('#accordion');
                    let arrow = app.$$('#arrow_toggle');
                    arrow.transition(600);

                    if (accordion.hasClass('accordion-item-opened')) {
                        arrow.transform('rotateX(180deg)');
                        app.accordion.close('#accordion');
                    }
                })
            },
            tabMounted: function () {
                this.lottieInit();
                this.swipersInit();
                this.checkConsent();
            }
        }
    };
</script>
<style>
    .swiper-pagination-bullet{
        background: var(--f7-text-editor-text-color);
        opacity: 0.65;
    }  
    .swiper-pagination-bullet-active{
        background: var(--f7-theme-color);
        opacity: 1;
    }  

    .menu-grid {
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, calc(50% - 5px));
        grid-gap: 10px;
    }

    .menu-grid__item {
        background-color: var(--f7-bars-bg-color);
        border-radius: 10px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1), 0 6px 20px 0 rgba(0, 0, 0, 0.1);
        text-align: center;
        text-transform: uppercase;
        color: #1e2f42;
        font-weight: bold;
        padding: 10px;
        display: flex;
        aspect-ratio: 1;
        align-content: center;
        justify-content: center;
        align-items: center;
    }

    .theme-dark .menu-grid__item {
        color: #efefef;
    }

    .menu-grid__item.small {
        vertical-align: middle;
        font-weight: 400;
        padding: 8px;
        text-align: left;
        background-color: #dff1e0;
        font-size: 0.8em;
    }

    .menu-grid__item.small i {
        float: left;
        margin-top: 8px;
        margin-right: 10px;
        font-size: 1.8em;
    }

    .menu-grid__icon {
        height: 55px;
    }

    .card-question {
        font-size: 16px;
        font-weight: 500;
        text-align: justify;
    }

    .consentTab {
        height: 100%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        z-index: 2;
        background-color: var(--f7-page-bg-color);
    }

    .pa-fontsize {
        font-size: x-large;
    }

    .padding-10 {
        padding: 10px;
    }

    .h100 {
        height: 100%;
    }

    .w100 {
        width: 100%;
    }

    .p-5px {
        padding: 5px;
    }
</style>